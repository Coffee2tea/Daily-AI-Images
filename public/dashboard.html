<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your AI Employee - T-Shirt Design</title>
    <meta name="description" content="T-Shirt Design Workflow Dashboard">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="/nav-component.js"></script>
</head>

<body>
    <!-- Navigation -->
    <nav-menu></nav-menu>

    <!-- Animated Background -->
    <div class="bg-animation"></div>

    <!-- Main Content -->
    <div class="container" style="padding-top: 80px;">
        <header class="gallery-header">
            <h1 class="gallery-title"><span class="material-symbols-outlined icon-gradient"
                    style="font-size: 1.2em;">palette</span> Your AI Employee - T-Shirt Design</h1>
            <p class="gallery-subtitle">One-click to trigger the complete T-Shirt design generation process</p>
        </header>

        <!-- Workflow Card -->
        <div class="confirm-card" style="max-width: 600px; margin: 2rem auto;">
            <!-- Status Display -->
            <div id="status-display" style="margin-bottom: 2rem;">
                <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                    <div class="status-item">
                        <div id="step1-icon" class="status-icon material-symbols-outlined">pause_circle</div>
                        <div class="status-label">ÊêúÁ¥¢ÂΩìÂâçÊµÅË°å Ideas</div>
                    </div>
                    <div class="status-item">
                        <div id="step2-icon" class="status-icon material-symbols-outlined">pause_circle</div>
                        <div class="status-label">Analyze & Generate Ideas</div>
                    </div>
                    <div class="status-item">
                        <div id="step3-icon" class="status-icon material-symbols-outlined">pause_circle</div>
                        <div class="status-label">Generate Images</div>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div id="progress-container" style="display: none; margin-bottom: 2rem;">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
                <p id="progress-text" style="text-align: center; color: #6b7280; margin-top: 0.5rem;">
                    Preparing...</p>
            </div>

            <!-- Start Button -->
            <div style="text-align: center;">
                <button id="start-btn" class="confirm-btn" onclick="startWorkflow()">
                    <span class="material-symbols-outlined">rocket_launch</span>
                    <span>Now, it's time to work!</span>
                </button>
            </div>

            <!-- Log Output -->
            <div id="log-container" style="display: none; margin-top: 2rem;">
                <h3 style="color: #4b5563; margin-bottom: 1rem;">üìã Execution Log</h3>
                <div id="log-output" class="log-output"></div>
            </div>
        </div>
    </div>

    <style>
        .status-item {
            text-align: center;
        }

        .status-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .status-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .progress-bar {
            height: 8px;
            background: var(--surface-container-highest);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .log-output {
            background: #f3f4f6;
            /* Gray 100 */
            border-radius: 8px;
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
            color: #374151;
            /* Gray 700 */
        }

        .log-output p {
            margin: 0.25rem 0;
        }

        .log-success {
            color: #10b981;
        }

        .log-error {
            color: #ef4444;
        }

        .log-info {
            color: #667eea;
        }
    </style>

    <script>
        let isRunning = false;
        let pollInterval = null;

        async function startWorkflow() {
            if (isRunning) return;
            isRunning = true;

            const btn = document.getElementById('start-btn');
            const progressContainer = document.getElementById('progress-container');
            const logContainer = document.getElementById('log-container');
            const logOutput = document.getElementById('log-output');

            // Reset UI
            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined spin-icon">hourglass_empty</span><span>Initializing...</span>';
            progressContainer.style.display = 'block';
            logContainer.style.display = 'block';
            logOutput.innerHTML = '';

            // Reset Progress Bar
            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('progress-text').textContent = 'Starting process, please wait... (Approx 3-5 mins)';

            // Reset Steps
            for (let i = 1; i <= 3; i++) {
                const icon = document.getElementById(`step${i}-icon`);
                icon.className = 'status-icon material-symbols-outlined';
                icon.textContent = 'pause_circle';
            }

            try {
                addLog('üöÄ Requesting background job...', 'info');

                // 1. Start Job
                const response = await fetch('/api/jobs/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) throw new Error('Failed to start job');

                const data = await response.json();
                const jobId = data.jobId;

                addLog(`‚úÖ Job started (ID: ${jobId})`, 'success');
                addLog('‚è≥ Polling in background to avoid timeout...', 'info');

                // 2. Poll Status
                startPolling(jobId);

            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                resetBtnState();
                isRunning = false;
            }
        }

        function startPolling(jobId) {
            const btn = document.getElementById('start-btn');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');

            // Track logs we've already shown to avoid dupes if simple polling
            let lastLogIndex = 0;

            pollInterval = setInterval(async () => {
                try {
                    const res = await fetch(`/api/jobs/${jobId}`);
                    if (!res.ok) return; // Retrying silently on network blip

                    const data = await res.json();
                    if (!data.success || !data.job) return;

                    const job = data.job;

                    // Update Logs
                    if (job.logs && job.logs.length > lastLogIndex) {
                        const newLogs = job.logs.slice(lastLogIndex);
                        newLogs.forEach(log => {
                            addLog(log.message, log.type || 'info');

                            // Update Step Icons based on log content/step
                            if (log.step) {
                                updateStepIcon(log.step);
                            }
                        });
                        lastLogIndex = job.logs.length;
                    }

                    // Update Progress bar roughly based on step
                    // Step 1: 33%, Step 2: 66%, Step 3: 100% (when done)
                    let pct = 0;
                    let text = "Processing...";

                    if (job.status === 'running') {
                        btn.innerHTML = '<span class="material-symbols-outlined spin-icon">sync</span><span>Working in Background...</span>';

                        if (job.currentStep === 1) { pct = 25; text = "ÊêúÁ¥¢ÂΩìÂâçÊµÅË°å Ideas..."; }
                        else if (job.currentStep === 2) { pct = 60; text = "AI Analyzing & Generating Ideas..."; }
                        else if (job.currentStep === 3) { pct = 85; text = "Generating AI Images (Takes 3-5 minutes)..."; }
                        else if (job.currentStep === 4) { pct = 95; text = "Uploading to Etsy..."; }

                    } else if (job.status === 'completed') {
                        pct = 100;
                        text = "Completed!";
                        clearInterval(pollInterval);
                        finishWorkflow();
                        return;
                    } else if (job.status === 'failed') {
                        clearInterval(pollInterval);
                        addLog(`‚ùå Job Failed: ${job.error}`, 'error');
                        resetBtnState();
                        isRunning = false;
                        return;
                    }

                    progressFill.style.width = `${pct}%`;
                    progressText.textContent = text;

                } catch (e) {
                    console.log('Polling error:', e);
                }
            }, 2000); // Poll every 2 seconds
        }

        function updateStepIcon(stepNumber) {
            // Mark previous steps as done
            for (let i = 1; i < stepNumber; i++) {
                const icon = document.getElementById(`step${i}-icon`);
                icon.textContent = 'check_circle';
                icon.classList.remove('spin-icon');
                icon.classList.add('text-success');
            }
            // Mark current step as running
            const current = document.getElementById(`step${stepNumber}-icon`);
            if (current) {
                current.textContent = 'sync';
                current.classList.add('spin-icon');
            }
        }

        function finishWorkflow() {
            const btn = document.getElementById('start-btn');

            // Mark all steps done
            for (let i = 1; i <= 3; i++) {
                const icon = document.getElementById(`step${i}-icon`);
                icon.textContent = 'check_circle';
                icon.classList.remove('spin-icon');
                icon.classList.add('text-success');
            }

            document.getElementById('progress-fill').style.width = '100%';
            document.getElementById('progress-text').textContent = 'All Finished!';

            addLog('üéâ Workflow successfully finished!', 'success');

            btn.innerHTML = '<span class="material-symbols-outlined">check_circle</span><span>Done! View Results</span>';
            btn.onclick = () => window.location.href = '/gallery';
            btn.disabled = false;
            isRunning = false;
        }

        function resetBtnState() {
            const btn = document.getElementById('start-btn');
            btn.innerHTML = '<span class="material-symbols-outlined">refresh</span><span>Retry</span>';
            btn.disabled = false;
        }

        function addLog(message, type = 'info') {
            const logOutput = document.getElementById('log-output');
            const p = document.createElement('p');
            p.className = `log-${type}`;
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logOutput.appendChild(p);
            logOutput.scrollTop = logOutput.scrollHeight;
        }
    </script>
</body>

</html>