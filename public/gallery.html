<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your AI Employee - Gallery</title>
  <meta name="description" content="AI Generated T-Shirt Design Gallery">
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <script src="/nav-component.js"></script>
</head>

<body>
  <!-- Navigation -->
  <nav-menu></nav-menu>

  <!-- Animated Background -->
  <div class="bg-animation"></div>

  <!-- Main Container -->
  <div class="container" style="padding-top: 80px;">
    <!-- Header -->
    <header class="gallery-header">
      <h1 class="gallery-title"><span class="material-symbols-outlined icon-gradient"
          style="font-size: 1.2em; vertical-align: middle;">photo_library</span> Your AI Employee - Gallery</h1>
      <p class="gallery-subtitle">Here are 10 unique designs generated by AI based on your analysis</p>
    </header>

    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Loading designs...</p>
    </div>

    <!-- Gallery Grid -->
    <div id="gallery" class="gallery-grid" style="display: none;"></div>

    <!-- Actions -->
    <div id="actions" class="gallery-actions" style="display: none;">
      <button class="btn btn-primary" onclick="downloadAll()">
        <span class="material-symbols-outlined">download</span> Download All
      </button>
      <button class="btn btn-secondary" onclick="shareGallery()">
        <span class="material-symbols-outlined">share</span> Share Link
      </button>
      <a href="/confirm" class="btn btn-secondary">
        <span class="material-symbols-outlined">arrow_back</span> Back to Confirm
      </a>
    </div>
  </div>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="lightbox" onclick="closeLightbox(event)">
    <div class="lightbox-content">
      <button class="lightbox-close" onclick="closeLightbox(event)"><span
          class="material-symbols-outlined">close</span></button>
      <img id="lightbox-image" class="lightbox-image" src="" alt="">
      <div class="lightbox-info">
        <h3 id="lightbox-title"></h3>
        <p id="lightbox-desc"></p>
      </div>
    </div>
  </div>

  <script>
    // Design data (will be loaded from API)
    let designs = [];

    // Load designs on page load
    document.addEventListener('DOMContentLoaded', loadDesigns);

    async function loadDesigns() {
      try {
        // Fetch manifest from API
        const response = await fetch('/api/images');
        const data = await response.json();

        if (data.success && data.images.length > 0) {
          designs = data.images;
          renderGallery();
        } else {
          // Show demo designs if no real data
          showDemoDesigns();
        }
      } catch (error) {
        console.error('Error loading designs:', error);
        showDemoDesigns();
      }
    }

    function showDemoDesigns() {
      // Generate demo data for testing
      designs = Array.from({ length: 10 }, (_, i) => ({
        id: i + 1,
        title: `Design ${String(i + 1).padStart(2, '0')}`,
        description: 'Creative designs generated by AI based on trending topics',
        imagePath: `/generated_images/design_${String(i + 1).padStart(2, '0')}.png`,
        style: ['ç®€çº¦', 'å¤å¤', 'æ³¢æ™®', 'æŠ½è±¡', 'è‡ªç„¶'][i % 5],
        colors: ['ç´«è‰²æ¸å˜', 'æš–è‰²è°ƒ', 'å†·è‰²è°ƒ', 'å•è‰²', 'å½©è™¹'][i % 5]
      }));
      renderGallery();
    }

    function renderGallery() {
      const galleryEl = document.getElementById('gallery');
      const loadingEl = document.getElementById('loading');
      const actionsEl = document.getElementById('actions');

      // Pagination Logic
      const itemsPerPage = 12;
      const totalPages = Math.ceil(designs.length / itemsPerPage);
      const currentPage = window.currentPage || 1;

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageDesigns = designs.slice(start, end);

      const html = pageDesigns.map((design, index) => `
        <div class="gallery-item ${design.isNew ? 'new-item-glow' : ''}" onclick="openLightbox(${start + index})">
           ${design.isNew ? '<div class="new-badge">NEW</div>' : ''}
          <div class="gallery-image-wrapper">
            <img 
              class="gallery-image" 
              src="${design.imagePath}" 
              alt="${design.title}"
              onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22400%22 viewBox=%220 0 400 400%22><rect fill=%22%231f2937%22 width=%22400%22 height=%22400%22/><text x=%2250%%22 y=%2250%%22 fill=%22%234b5563%22 font-size=%2248%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22>ðŸŽ¨</text><text x=%2250%%22 y=%2265%%22 fill=%22%239ca3af%22 font-size=%2216%22 text-anchor=%22middle%22>${design.title}</text></svg>'"
            >
            <div class="gallery-overlay">
              <span>Click to View</span>
            </div>
          </div>
          <div class="gallery-info">
            <h3>${design.title}</h3>
            <p>${design.description || `é£Žæ ¼: ${design.style} | è‰²å½©: ${design.colors}`}</p>
          </div>
        </div>
      `).join('');

      // Add Pagination Controls
      let paginationHtml = '';
      if (totalPages > 1) {
        paginationHtml = `<div class="pagination" style="width:100%; display:flex; justify-content:center; gap:10px; margin-top:20px;">
            <button class="btn btn-secondary" onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
            <span style="align-self:center;">Page ${currentPage} of ${totalPages}</span>
            <button class="btn btn-secondary" onclick="changePage(1)" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
          </div>`;
      }

      galleryEl.innerHTML = html;

      // Append pagination
      const paginationDiv = document.createElement('div');
      paginationDiv.innerHTML = paginationHtml;
      // Remove old pagination if exists (hacky to just append, but efficient for now)
      const oldPag = document.getElementById('pagination-controls');
      if (oldPag) oldPag.remove();
      paginationDiv.id = 'pagination-controls';
      galleryEl.parentNode.insertBefore(paginationDiv, actionsEl);

      // Hide loading, show gallery
      loadingEl.style.display = 'none';
      galleryEl.style.display = 'grid';
      actionsEl.style.display = 'flex';
    }

    window.currentPage = 1;
    window.changePage = function (delta) {
      const totalPages = Math.ceil(designs.length / 12);
      let newPage = window.currentPage + delta;
      if (newPage >= 1 && newPage <= totalPages) {
        window.currentPage = newPage;
        renderGallery();
        window.scrollTo(0, 0);
      }
    }

    function openLightbox(index) {
      const design = designs[index];
      const lightbox = document.getElementById('lightbox');
      const image = document.getElementById('lightbox-image');
      const title = document.getElementById('lightbox-title');
      const desc = document.getElementById('lightbox-desc');

      image.src = design.imagePath;
      image.alt = design.title;
      title.textContent = design.title;
      desc.textContent = design.description || `é£Žæ ¼: ${design.style} | è‰²å½©: ${design.colors}`;

      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox(event) {
      if (event.target.classList.contains('lightbox') ||
        event.target.classList.contains('lightbox-close')) {
        const lightbox = document.getElementById('lightbox');
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
      }
    }

    async function downloadAll() {
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="material-symbols-outlined spin-icon">hourglass_empty</span> Preparing download...';
      btn.disabled = true;

      try {
        // Download each image
        for (const design of designs) {
          const response = await fetch(design.imagePath);
          if (response.ok) {
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${design.title}.png`;
            a.click();
            URL.revokeObjectURL(url);

            // Small delay between downloads
            await new Promise(r => setTimeout(r, 300));
          }
        }
        btn.innerHTML = '<span class="material-symbols-outlined">check_circle</span> Download Complete!';
      } catch (error) {
        console.error('Download error:', error);
        btn.innerHTML = '<span class="material-symbols-outlined">error</span> Download Failed';
      }

      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }, 2000);
    }

    function shareGallery() {
      const url = window.location.href;

      if (navigator.share) {
        navigator.share({
          title: 'T-Shirt Design Gallery',
          text: 'Check out my AI generated T-Shirt designs!',
          url: url
        });
      } else if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
          const btn = event.target;
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span class="material-symbols-outlined">check</span> Link Copied!';
          setTimeout(() => {
            btn.innerHTML = originalText;
          }, 2000);
        });
      } else {
        prompt('Copy this link to share:', url);
      }
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const lightbox = document.getElementById('lightbox');
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
      }
    });
  </script>
</body>

</html>